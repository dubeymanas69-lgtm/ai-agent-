<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        body {
            overflow-y: auto;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .drag-over {
            background-color: #eff6ff;
            border: 2px dashed #3b82f6;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 font-sans min-h-screen selection:bg-blue-100 selection:text-blue-900">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- UTILS ---
        const uid = () => Math.random().toString(36).slice(2, 9);
        const isoDate = (d) => d.toISOString().slice(0, 10);
        const toIcalDateTime = (dt) => dt.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";

        // --- COMPONENTS ---

        function Toast({ message, onClose }) {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className="fixed bottom-6 right-6 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3 z-50 fade-in">
                    <span className="text-green-400 text-xl">‚úì</span>
                    <span className="font-medium">{message}</span>
                </div>
            );
        }

        function Navbar({ setView, currentView }) {
            const navItems = [
                { id: 'home', label: 'Home', icon: 'üè†' },
                { id: 'planner', label: 'Planner', icon: 'üìÖ' },
                { id: 'chat', label: 'Assistant', icon: 'ü§ñ' },
                { id: 'notes', label: 'Notes', icon: 'üìù' },
            ];

            return (
                <nav className="bg-white border-b sticky top-0 z-40 shadow-sm/50 backdrop-blur-md bg-white/90">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex justify-between h-16">
                            <div className="flex items-center cursor-pointer gap-2" onClick={() => setView('home')}>
                                <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">AI</div>
                                <span className="text-xl font-bold text-gray-900 tracking-tight">TaskFlow</span>
                            </div>
                            <div className="flex items-center space-x-2">
                                {navItems.map(item => (
                                    <button
                                        key={item.id}
                                        onClick={() => setView(item.id)}
                                        className={`px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 flex items-center gap-2
                                            ${currentView === item.id
                                                ? 'bg-blue-50 text-blue-700 shadow-sm ring-1 ring-blue-200'
                                                : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'}`}
                                    >
                                        <span>{item.icon}</span>
                                        {item.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                </nav>
            );
        }

        function Home({ setView }) {
            return (
                <div className="max-w-5xl mx-auto px-6 py-16 fade-in">
                    <div className="text-center mb-16">
                        <h1 className="text-5xl font-extrabold text-gray-900 mb-6 tracking-tight">
                            Organize your life with <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">Intelligent Agents</span>
                        </h1>
                        <p className="text-xl text-gray-500 max-w-2xl mx-auto leading-relaxed">
                            A unified workspace for your tasks, schedule, and ideas. Powered by AI to help you get more done.
                        </p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        {[
                            { id: 'planner', title: 'Weekly Planner', icon: 'üìÖ', desc: 'Visual drag-and-drop scheduling with auto-blocking.' },
                            { id: 'chat', title: 'AI Assistant', icon: 'ü§ñ', desc: 'Chat naturally to add tasks, query your schedule, and more.' },
                            { id: 'notes', title: 'Notes & Focus', icon: 'üìù', desc: 'Capture quick thoughts and track your daily top priorities.' }
                        ].map(card => (
                            <div key={card.id} onClick={() => setView(card.id)}
                                className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group">
                                <div className="text-4xl mb-6 bg-blue-50 w-16 h-16 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">{card.icon}</div>
                                <h3 className="text-xl font-bold text-gray-900 mb-3">{card.title}</h3>
                                <p className="text-gray-500 leading-relaxed">{card.desc}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function ChatPage({ showToast }) {
            const [messages, setMessages] = useState([
                { role: 'assistant', text: 'Hello! I am your AI Task Manager. Tell me what you need to do, and I\'ll organize it for you.' }
            ]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const endRef = useRef(null);

            useEffect(() => endRef.current?.scrollIntoView({ behavior: "smooth" }), [messages]);

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!input.trim()) return;
                const userMsg = input;
                setInput("");
                setMessages(p => [...p, { role: 'user', text: userMsg }]);
                setLoading(true);

                try {
                    const res = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMsg })
                    });
                    const data = await res.json();
                    setMessages(p => [...p, { role: 'assistant', text: data.response }]);

                    if (data.action === 'add_task') showToast("Task added successfully!");
                    if (data.action === 'delete_task') showToast("Task deleted!");
                    if (data.action === 'update_task') showToast("Task updated!");

                } catch (err) {
                    setMessages(p => [...p, { role: 'assistant', text: "Error connecting to server. Is it running?" }]);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="max-w-4xl mx-auto p-6 h-[calc(100vh-4rem)] flex flex-col fade-in">
                    <div className="bg-white rounded-2xl shadow-lg border border-gray-100 flex-1 flex flex-col overflow-hidden">
                        <div className="p-4 border-b bg-gray-50/50 font-bold text-gray-700 flex items-center gap-2">
                            <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            AI Assistant
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-gray-50/30">
                            {messages.map((m, i) => (
                                <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[80%] rounded-2xl px-5 py-3 shadow-sm text-sm leading-relaxed
                                        ${m.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white text-gray-800 border border-gray-100 rounded-bl-none'}`}>
                                        {m.text}
                                    </div>
                                </div>
                            ))}
                            {loading && (
                                <div className="flex justify-start">
                                    <div className="bg-white border border-gray-100 rounded-2xl rounded-bl-none px-5 py-3 shadow-sm flex gap-1 items-center">
                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                                    </div>
                                </div>
                            )}
                            <div ref={endRef} />
                        </div>
                        <form onSubmit={sendMessage} className="p-4 border-t bg-white flex gap-3">
                            <input className="flex-1 border border-gray-200 rounded-full px-6 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all bg-gray-50 focus:bg-white"
                                placeholder="Type a message... (e.g., 'Schedule a meeting for Friday at 2pm')" value={input} onChange={e => setInput(e.target.value)} autoFocus />
                            <button disabled={loading} className="bg-blue-600 text-white px-8 py-3 rounded-full font-bold hover:bg-blue-700 disabled:opacity-50 transition-all shadow-md hover:shadow-lg transform active:scale-95">
                                Send
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function NotesPage() {
            const [note, setNote] = useState(localStorage.getItem("planner_notepad") || "");
            const [todos, setTodos] = useState(JSON.parse(localStorage.getItem("planner_daily_todos") || "[]"));
            const [newTodo, setNewTodo] = useState("");

            useEffect(() => localStorage.setItem("planner_notepad", note), [note]);
            useEffect(() => localStorage.setItem("planner_daily_todos", JSON.stringify(todos)), [todos]);

            const addTodo = (e) => {
                e.preventDefault();
                if (!newTodo.trim()) return;
                setTodos([...todos, { id: Date.now(), text: newTodo, done: false }]);
                setNewTodo("");
            };

            return (
                <div className="max-w-6xl mx-auto p-6 grid grid-cols-1 md:grid-cols-2 gap-8 h-[calc(100vh-4rem)] fade-in">
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full overflow-hidden">
                        <div className="p-4 border-b bg-yellow-50/50 font-bold text-yellow-800 flex items-center gap-2">
                            <span>üìù</span> Notepad
                        </div>
                        <textarea className="flex-1 w-full p-6 resize-none outline-none text-gray-700 leading-relaxed bg-yellow-50/10 focus:bg-white transition-colors"
                            placeholder="Start typing your notes here..." value={note} onChange={e => setNote(e.target.value)} />
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full overflow-hidden">
                        <div className="p-4 border-b bg-green-50/50 font-bold text-green-800 flex items-center gap-2">
                            <span>‚úÖ</span> Today's Focus
                        </div>
                        <div className="flex-1 overflow-y-auto p-4">
                            <ul className="space-y-2">
                                {todos.map(t => (
                                    <li key={t.id} className="group flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl border border-transparent hover:border-gray-100 transition-all">
                                        <input type="checkbox" checked={t.done} onChange={() => setTodos(todos.map(x => x.id === t.id ? { ...x, done: !x.done } : x))}
                                            className="w-5 h-5 text-green-600 rounded focus:ring-green-500 cursor-pointer" />
                                        <span className={`flex-1 ${t.done ? 'line-through text-gray-400' : 'text-gray-700'}`}>{t.text}</span>
                                        <button onClick={() => setTodos(todos.filter(x => x.id !== t.id))} className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 px-2 transition-opacity">√ó</button>
                                    </li>
                                ))}
                                {todos.length === 0 && <div className="text-center text-gray-400 mt-10 italic">No tasks for today yet.</div>}
                            </ul>
                        </div>
                        <form onSubmit={addTodo} className="p-4 border-t bg-gray-50/50">
                            <input className="w-full border border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none transition-all bg-white"
                                placeholder="+ Add a new goal..." value={newTodo} onChange={e => setNewTodo(e.target.value)} />
                        </form>
                    </div>
                </div>
            );
        }

        function PlannerPage({ showToast }) {
            const [weekStart, setWeekStart] = useState(() => {
                const now = new Date();
                const d = new Date(now);
                d.setDate(now.getDate() - ((now.getDay() + 6) % 7));
                d.setHours(0, 0, 0, 0);
                return d;
            });
            const [tasks, setTasks] = useState([]);
            const [showAdd, setShowAdd] = useState(false);
            const [form, setForm] = useState({ name: "", duration: 60, priority: "medium", deadline: "" });

            const fetchTasks = async () => {
                try {
                    const res = await fetch('/api/tasks');
                    const data = await res.json();
                    setTasks(data);
                } catch (e) { console.error(e); }
            };

            useEffect(() => { fetchTasks(); }, []);

            const saveTasks = async (newTasks) => {
                setTasks(newTasks);
                await fetch('/api/tasks', { method: 'POST', body: JSON.stringify(newTasks) });
            };

            const deleteTask = async (id) => {
                if (!confirm("Are you sure you want to delete this task?")) return;
                const newTasks = tasks.filter(t => t.id !== id);
                await saveTasks(newTasks);
                showToast("Task deleted.");
            };

            // Drag and Drop Handlers
            const handleDragStart = (e, taskId) => {
                e.dataTransfer.setData("taskId", taskId);
            };

            const handleDrop = async (e, dateStr) => {
                e.preventDefault();
                const taskId = e.dataTransfer.getData("taskId");
                const task = tasks.find(t => t.id === taskId);

                if (task) {
                    // Update task with new scheduled_date
                    const updatedTask = { ...task, scheduled_date: dateStr };
                    const newTasks = tasks.map(t => t.id === taskId ? updatedTask : t);
                    await saveTasks(newTasks);
                    showToast(`Task moved to ${dateStr}`);
                }
                e.currentTarget.classList.remove('drag-over');
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.currentTarget.classList.add('drag-over');
            };

            const handleDragLeave = (e) => {
                e.currentTarget.classList.remove('drag-over');
            };

            const addTask = () => {
                const nt = {
                    id: uid(), task_name: form.name || "Untitled", duration_minutes: Number(form.duration),
                    priority: form.priority, deadline: form.deadline || null, created_at: new Date().toISOString()
                };
                saveTasks([...tasks, nt]);
                setShowAdd(false); setForm({ name: "", duration: 60, priority: "medium", deadline: "" });
                showToast("Task added to backlog.");
            };

            const DAYS = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

            return (
                <div className="max-w-7xl mx-auto p-6 h-[calc(100vh-4rem)] flex flex-col fade-in">
                    <div className="bg-white rounded-2xl shadow-lg border border-gray-100 h-full flex flex-col overflow-hidden">
                        <div className="p-4 border-b flex items-center justify-between bg-white flex-shrink-0">
                            <div className="flex gap-2 items-center">
                                <button onClick={() => { const d = new Date(weekStart); d.setDate(d.getDate() - 7); setWeekStart(d); }} className="p-2 hover:bg-gray-100 rounded-full transition-colors">‚Üê</button>
                                <span className="font-bold text-lg w-40 text-center text-gray-700">{isoDate(weekStart)}</span>
                                <button onClick={() => { const d = new Date(weekStart); d.setDate(d.getDate() + 7); setWeekStart(d); }} className="p-2 hover:bg-gray-100 rounded-full transition-colors">‚Üí</button>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => setShowAdd(true)} className="px-5 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 font-medium transition-all transform active:scale-95">+ Add Task</button>
                            </div>
                        </div>

                        {/* Calendar Columns */}
                        <div className="flex-1 overflow-auto bg-gray-50/50 p-4">
                            <div className="grid grid-cols-7 gap-4 h-full min-w-[1000px]">
                                {DAYS.map((d, i) => {
                                    const date = new Date(weekStart);
                                    date.setDate(date.getDate() + i);
                                    const dateStr = isoDate(date);

                                    // Filter tasks for this day
                                    const dayTasks = tasks.filter(t => t.scheduled_date === dateStr);

                                    return (
                                        <div
                                            key={d}
                                            className="bg-white rounded-xl border border-gray-200 flex flex-col h-full shadow-sm transition-colors"
                                            onDrop={(e) => handleDrop(e, dateStr)}
                                            onDragOver={handleDragOver}
                                            onDragLeave={handleDragLeave}
                                        >
                                            <div className="p-3 border-b bg-gray-50/50 rounded-t-xl text-center">
                                                <div className="font-bold text-gray-800">{d}</div>
                                                <div className="text-xs text-gray-400">{dateStr.slice(5)}</div>
                                            </div>
                                            <div className="flex-1 p-2 space-y-2 overflow-y-auto">
                                                {dayTasks.map(t => (
                                                    <div
                                                        key={t.id}
                                                        draggable
                                                        onDragStart={(e) => handleDragStart(e, t.id)}
                                                        className={`p-3 rounded-lg border shadow-sm cursor-grab active:cursor-grabbing hover:shadow-md transition-all
                                                            ${t.priority === 'high' ? 'bg-red-50 border-red-100' : t.priority === 'medium' ? 'bg-blue-50 border-blue-100' : 'bg-green-50 border-green-100'}`}
                                                    >
                                                        <div className="font-bold text-sm text-gray-800 truncate">{t.task_name}</div>
                                                        <div className="text-xs text-gray-500 mt-1 flex justify-between">
                                                            <span>{t.duration_minutes}m</span>
                                                            <span className="uppercase text-[10px] font-bold tracking-wider opacity-60">{t.priority}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                                {dayTasks.length === 0 && <div className="text-center text-gray-300 text-xs mt-4">Drop tasks here</div>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Backlog */}
                        <div className="h-48 border-t bg-white p-6 overflow-y-auto flex-shrink-0">
                            <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2">
                                <span>üìã</span> Unscheduled Backlog
                                <span className="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded-full">{tasks.filter(t => !t.scheduled_date).length} tasks</span>
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                {tasks.filter(t => !t.scheduled_date).map(t => (
                                    <div
                                        key={t.id}
                                        draggable
                                        onDragStart={(e) => handleDragStart(e, t.id)}
                                        className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center group hover:border-blue-200 hover:shadow-md transition-all cursor-grab active:cursor-grabbing"
                                    >
                                        <div className="truncate pr-2">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className={`w-2 h-2 rounded-full ${t.priority === 'high' ? 'bg-red-500' : t.priority === 'medium' ? 'bg-blue-500' : 'bg-green-500'}`}></span>
                                                <span className="font-medium text-sm text-gray-800 truncate">{t.task_name}</span>
                                            </div>
                                            <div className="text-xs text-gray-400 pl-4">{t.duration_minutes}m</div>
                                        </div>
                                        <button onClick={() => deleteTask(t.id)} className="text-gray-300 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-all opacity-0 group-hover:opacity-100">
                                            √ó
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {showAdd && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 fade-in">
                                <div className="bg-white p-8 rounded-2xl shadow-2xl w-[480px] transform transition-all scale-100">
                                    <h3 className="font-bold text-2xl mb-6 text-gray-900">Add New Task</h3>
                                    <div className="space-y-5">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1.5 uppercase tracking-wider">Task Name</label>
                                            <input className="w-full border border-gray-200 bg-gray-50 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all" placeholder="e.g. Finish Project Report" value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} autoFocus />
                                        </div>
                                        <div className="flex gap-4">
                                            <div className="flex-1">
                                                <label className="block text-xs font-bold text-gray-500 mb-1.5 uppercase tracking-wider">Duration (min)</label>
                                                <input type="number" className="w-full border border-gray-200 bg-gray-50 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all" placeholder="60" value={form.duration} onChange={e => setForm({ ...form, duration: e.target.value })} />
                                            </div>
                                            <div className="flex-1">
                                                <label className="block text-xs font-bold text-gray-500 mb-1.5 uppercase tracking-wider">Priority</label>
                                                <select className="w-full border border-gray-200 bg-gray-50 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all appearance-none" value={form.priority} onChange={e => setForm({ ...form, priority: e.target.value })}>
                                                    <option value="high">High üî•</option>
                                                    <option value="medium">Medium ‚ö°</option>
                                                    <option value="low">Low ‚òï</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1.5 uppercase tracking-wider">Deadline (Optional)</label>
                                            <input type="date" className="w-full border border-gray-200 bg-gray-50 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all" value={form.deadline} onChange={e => setForm({ ...form, deadline: e.target.value })} />
                                        </div>
                                    </div>
                                    <div className="flex justify-end gap-3 mt-8">
                                        <button onClick={() => setShowAdd(false)} className="px-6 py-2.5 text-gray-600 hover:bg-gray-100 rounded-xl font-medium transition-colors">Cancel</button>
                                        <button onClick={addTask} className="px-6 py-2.5 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all transform active:scale-95">Add Task</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function App() {
            const [view, setView] = useState('home');
            const [toast, setToast] = useState(null);

            const showToast = (msg) => setToast(msg);

            return (
                <div className="min-h-screen flex flex-col bg-gray-50">
                    <Navbar setView={setView} currentView={view} />
                    <div className="flex-1 overflow-hidden">
                        {view === 'home' && <Home setView={setView} />}
                        {view === 'planner' && <PlannerPage showToast={showToast} />}
                        {view === 'chat' && <ChatPage showToast={showToast} />}
                        {view === 'notes' && <NotesPage />}
                    </div>
                    {toast && <Toast message={toast} onClose={() => setToast(null)} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>